<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>個人筆記本 — 作者:李振偉</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#6ee7b7;--glass: rgba(255,255,255,0.03)}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans TC',PingFang TC,Helvetica,Arial;color:#e6eef6;background:linear-gradient(180deg,#071022 0%, #08162a 60%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px}
    .app{width:100%;max-width:1100px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;overflow:hidden;box-shadow:0 10px 30px rgba(2,6,23,0.7);display:grid;grid-template-columns:360px 1fr}
    header{padding:20px 24px;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:space-between}
    .left-title{display:flex;align-items:center;gap:12px}
    h1{margin:0;font-size:18px}
    .muted{color:var(--muted);font-size:13px}
    .sidebar{padding:16px;border-right:1px solid rgba(255,255,255,0.03);background:linear-gradient(0deg, rgba(255,255,255,0.01), transparent)}
    .controls{display:flex;gap:8px;margin-bottom:12px}
    button{background:var(--glass);border:1px solid rgba(255,255,255,0.04);color:#e6eef6;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:600}
    button.positive{border-color:rgba(110,231,183,0.2)}
    .search{display:flex;margin-bottom:12px}
    .search input{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .note-list{height:64vh;overflow:auto;padding-right:6px}
    .note-item{padding:10px;border-radius:8px;margin-bottom:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));cursor:pointer;border:1px solid rgba(255,255,255,0.02);}
    .note-item .title{font-weight:700}
    .meta{font-size:12px;color:var(--muted);margin-top:6px}
    main{padding:18px}
    .editor{display:flex;flex-direction:column;height:80vh}
    .editor .title-input{font-size:20px;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    textarea{flex:1;margin-top:12px;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);resize:none;background:transparent;color:inherit}
    .footer{display:flex;align-items:center;justify-content:space-between;padding-top:10px}
    .smallbtn{background:transparent;border:1px dashed rgba(255,255,255,0.03);padding:8px 10px;border-radius:8px}
    .danger{border-color:rgba(255,90,90,0.12)}
    .meta-right{font-size:13px;color:var(--muted)}
    .empty{display:flex;align-items:center;justify-content:center;height:60vh;color:var(--muted);font-size:18px}
    .top-actions{display:flex;gap:8px}
    @media(max-width:880px){.app{grid-template-columns:1fr} .sidebar{order:2} main{order:1}}
    footer.app-foot{padding:12px 18px;background:transparent;border-top:1px solid rgba(255,255,255,0.02);display:flex;justify-content:space-between;align-items:center}
    a.link{color:var(--accent);text-decoration:none;font-weight:700}
  </style>
</head>
<body>
  <div class="app">
    <div style="display:flex;flex-direction:column">
      <header>
        <div class="left-title">
          <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="3" width="20" height="18" rx="2" stroke="currentColor" stroke-opacity="0.15" stroke-width="1.2"/><path d="M7 8h10M7 12h10M7 16h6" stroke="currentColor" stroke-opacity="0.25" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <div>
            <h1>個人筆記本</h1>
            <div class="muted">簡易筆記 — 內容儲存在 Local Storage</div>
          </div>
        </div>
        <div class="muted">作者:李振偉</div>
      </header>
      <div class="sidebar" style="padding:16px;flex:1;display:flex;flex-direction:column">
        <div class="controls">
          <button id="newNoteBtn" class="positive">＋ 新筆記</button>
          <button id="exportBtn" title="匯出所有筆記(JSON)">匯出</button>
          <button id="importBtn" title="匯入筆記(JSON)">匯入</button>
        </div>
        <div class="search"><input id="searchInput" placeholder="搜尋標題或內容..." /></div>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <div class="muted">共 <span id="count">0</span> 筆</div>
          <div style="flex:1"></div>
          <select id="sortSel" style="background:transparent;border-radius:8px;padding:6px;border:1px solid rgba(255,255,255,0.03);color:inherit">
            <option value="modified_desc">最近編輯</option>
            <option value="modified_asc">最舊編輯</option>
            <option value="title_asc">標題 A→Z</option>
            <option value="title_desc">標題 Z→A</option>
          </select>
        </div>
        <div class="note-list" id="noteList" tabindex="0">
          <!-- notes -->
        </div>
        <div style="margin-top:auto;padding-top:10px">
          <div style="font-size:12px;color:var(--muted);">Local Storage key: <code style="color:var(--accent);">lv_notes_v1</code></div>
        </div>
      </div>
    </div>
    <main>
      <div class="editor" id="editorArea">
        <input class="title-input" id="noteTitle" placeholder="標題（必填）" />
        <textarea id="noteBody" placeholder="在此撰寫筆記..." spellcheck="true"></textarea>
        <div class="footer">
          <div style="display:flex;gap:8px;align-items:center">
            <button id="saveBtn">儲存</button>
            <button id="deleteBtn" class="danger smallbtn">刪除</button>
            <div class="muted" id="noteMeta"></div>
          </div>
          <div class="meta-right">
            <span id="autosaveState">未儲存</span>
          </div>
        </div>
      </div>
      <div id="emptyState" class="empty" style="display:none">選擇或建立一筆筆記開始書寫 ✍️</div>
    </main>
    <footer class="app-foot">
      <div class="muted">筆記會儲存在本機瀏覽器的 Local Storage 中（只有這台裝置可讀取）。</div>
      <div>作者: 李振偉</div>
    </footer>
  </div>

  <input type="file" id="fileInput" accept="application/json" style="display:none" />

  <script>
    // LocalStorage key
    const LS_KEY = 'lv_notes_v1';

    // Elements
    const newNoteBtn = document.getElementById('newNoteBtn');
    const noteList = document.getElementById('noteList');
    const noteTitle = document.getElementById('noteTitle');
    const noteBody = document.getElementById('noteBody');
    const saveBtn = document.getElementById('saveBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const countEl = document.getElementById('count');
    const searchInput = document.getElementById('searchInput');
    const sortSel = document.getElementById('sortSel');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const fileInput = document.getElementById('fileInput');
    const noteMeta = document.getElementById('noteMeta');
    const autosaveState = document.getElementById('autosaveState');
    const emptyState = document.getElementById('emptyState');

    let notes = []; // {id,title,body,created,modified}
    let currentId = null;
    let autoSaveTimer = null;

    // utilities
    function uid(){return 'n_'+Math.random().toString(36).slice(2,9)}
    function ts(){return new Date().toISOString()}
    function formatDate(iso){const d=new Date(iso);return d.toLocaleString();}

    // load
    function loadNotes(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        notes = raw ? JSON.parse(raw) : [];
      }catch(e){console.error('parse error',e);notes=[]}
    }
    function saveNotes(){
      localStorage.setItem(LS_KEY, JSON.stringify(notes));
    }

    // render list
    function renderList(){
      const q = searchInput.value.trim().toLowerCase();
      let out = notes.slice();
      const sort = sortSel.value;
      out.sort((a,b)=>{
        if(sort==='modified_desc') return b.modified.localeCompare(a.modified);
        if(sort==='modified_asc') return a.modified.localeCompare(b.modified);
        if(sort==='title_asc') return (a.title||'').localeCompare(b.title||'');
        if(sort==='title_desc') return (b.title||'').localeCompare(a.title||'');
        return 0;
      });
      noteList.innerHTML = '';
      const filtered = out.filter(n=>{
        if(!q) return true;
        return (n.title||'').toLowerCase().includes(q) || (n.body||'').toLowerCase().includes(q);
      });
      filtered.forEach(n=>{
        const el = document.createElement('div');
        el.className='note-item';
        el.dataset.id = n.id;
        el.innerHTML = `<div class="title">${escapeHtml(n.title||'（無標題）')}</div><div class="meta">${escapeHtml(n.body?.slice(0,80)||'')} · ${formatDate(n.modified)}</div>`;
        el.addEventListener('click', ()=>{openNote(n.id)});
        noteList.appendChild(el);
      });
      countEl.textContent = filtered.length;
    }

    function escapeHtml(str){
      return String(str||'').replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[s]));
    }

    // open note
    function openNote(id){
      const n = notes.find(x=>x.id===id);
      if(!n) return;
      currentId = id;
      noteTitle.value = n.title || '';
      noteBody.value = n.body || '';
      noteMeta.textContent = `建立：${formatDate(n.created)} · 最後：${formatDate(n.modified)}`;
      emptyState.style.display='none';
      autosaveState.textContent = '已載入';
      scheduleAutoSave();
      highlightSelected();
    }

    function highlightSelected(){
      document.querySelectorAll('.note-item').forEach(el=> el.style.outline = (el.dataset.id===currentId)?'2px solid rgba(110,231,183,0.12)':'none');
    }

    // create
    function createNote(){
      const id = uid();
      const now = ts();
      const n = {id, title:'', body:'', created:now, modified:now};
      notes.unshift(n);
      saveNotes();
      renderList();
      openNote(id);
    }

    // save current
    function saveCurrent(){
      if(!currentId) return;
      const n = notes.find(x=>x.id===currentId);
      if(!n) return;
      n.title = noteTitle.value.trim();
      n.body = noteBody.value;
      n.modified = ts();
      saveNotes();
      renderList();
      noteMeta.textContent = `建立：${formatDate(n.created)} · 最後：${formatDate(n.modified)}`;
      autosaveState.textContent = '已儲存';
      clearAutoSaveTimer();
    }

    // delete
    function deleteCurrent(){
      if(!currentId) return;
      const idx = notes.findIndex(x=>x.id===currentId);
      if(idx===-1) return;
      if(!confirm('確定要刪除此筆記？此動作無法復原。')) return;
      notes.splice(idx,1);
      currentId = null;
      saveNotes();
      renderList();
      noteTitle.value='';noteBody.value='';noteMeta.textContent='';
      emptyState.style.display='flex';
    }

    // autosave scheduling
    function scheduleAutoSave(){
      clearAutoSaveTimer();
      autosaveState.textContent = '草稿 (未儲存)';
      autoSaveTimer = setTimeout(()=>{
        saveCurrent();
      }, 1800);
    }
    function clearAutoSaveTimer(){ if(autoSaveTimer){ clearTimeout(autoSaveTimer); autoSaveTimer = null; } }

    // export
    function exportNotes(){
      const data = JSON.stringify({exportedAt:ts(),notes},null,2);
      const blob = new Blob([data],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `lv_notes_${new Date().toISOString().slice(0,19)}.json`; a.click();
      URL.revokeObjectURL(url);
    }

    // import
    function importNotesFile(file){
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const obj = JSON.parse(reader.result);
          if(Array.isArray(obj)){
            notes = obj;
          }else if(obj && Array.isArray(obj.notes)){
            notes = obj.notes;
          }else{
            alert('找不到筆記資料。請上傳由本系統匯出的 JSON 格式。');
            return;
          }
          // ensure ids and timestamps
          notes = notes.map(n=>({id: n.id || uid(), title: n.title||'', body: n.body||'', created: n.created||ts(), modified: n.modified||n.created||ts()}));
          saveNotes(); renderList(); alert('匯入完成');
        }catch(e){alert('解析失敗：'+e.message)}
      };
      reader.readAsText(file);
    }

    // event bindings
    newNoteBtn.addEventListener('click', ()=>{createNote();});
    saveBtn.addEventListener('click', ()=>{saveCurrent();});
    deleteBtn.addEventListener('click', ()=>{deleteCurrent();});
    searchInput.addEventListener('input', ()=>{renderList();});
    sortSel.addEventListener('change', ()=>{renderList();});

    noteTitle.addEventListener('input', ()=>{autosaveState.textContent = '草稿 (未儲存)'; scheduleAutoSave();});
    noteBody.addEventListener('input', ()=>{autosaveState.textContent = '草稿 (未儲存)'; scheduleAutoSave();});

    exportBtn.addEventListener('click', ()=>{exportNotes();});
    importBtn.addEventListener('click', ()=>{fileInput.click();});
    fileInput.addEventListener('change', (e)=>{ if(e.target.files.length) importNotesFile(e.target.files[0]); e.target.value=''; });

    // keyboard shortcuts
    document.addEventListener('keydown', (e)=>{
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='n'){ e.preventDefault(); createNote(); }
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); saveCurrent(); }
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='f'){ e.preventDefault(); searchInput.focus(); }
    });

    // initial load
    loadNotes();
    renderList();
    if(notes.length) openNote(notes[0].id); else { emptyState.style.display='flex'; }

    // expose for debugging (optional)
    window._lv_notes = notes;
  </script>
</body>
</html>
